{% extends "base.html" %}

{% block title %}{{ team.name }} - {% if team.format == TeamFormat.SOLO %}My Entry{% else %}Team Members{% endif %} - {{ super() }}{% endblock %}

{% block content %}
    {% include '_team_status_alerts.html' %}

    {% set captain_has_joined = active_members | selectattr('user_id', 'equalto', team.captain_id) | list | length > 0 %}
    <h1> {{team.name }}{% if team.format == TeamFormat.TEAM %} Members{% endif %}</h1>

    <div class="row">
        <div class="col-12">
            {% if team.format == TeamFormat.TEAM %}
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Roster ({{ active_members|length + withdrawn_members|length }})</h5>
                    {% if permissions.can_manage_team(current_user, team) and active_members %}
                    <div class="btn-group btn-group-sm" role="group" aria-label="Export team data">
                        <a href="{{ url_for('teams.export_members_csv', team_id=team.id) }}" class="btn btn-outline-secondary btn-sm" title="Export as CSV">
                            <ion-icon name="download-outline" class="me-1"></ion-icon>CSV
                        </a>
                        <a href="{{ url_for('teams.export_members_tsv', team_id=team.id) }}" class="btn btn-outline-secondary btn-sm" title="Export as TSV">
                            <ion-icon name="download-outline" class="me-1"></ion-icon>TSV
                        </a>
                    </div>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Member</th>
                                    <th>Preferences</th>
                                    <th>Joined</th>
                                    {% if permissions.can_manage_team(current_user, team) %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Active Team Members -->
                                {% if active_members %}
                                <tr>
                                    <td colspan="{% if permissions.can_manage_team(current_user, team) %}4{% else %}3{% endif %}" class="fw-bold text-success px-3 py-2">
                                        Active ({{ active_members|length }})
                                    </td>
                                </tr>
                                {% for membership in active_members %}
                                <tr {% if current_user.is_authenticated and membership.user_id == current_user.id %}class="table-primary-subtle"{% endif %}>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if membership.user.avatar_url %}
                                                <img src="{{ membership.user.avatar_url }}" alt="{{ membership.user.name }}"
                                                     class="rounded-circle me-3 {% if current_user.is_authenticated and membership.user_id == current_user.id %}border border-2 border-primary-subtle{% endif %}" width="40" height="40">
                                            {% endif %}
                                            <div>
                                                <strong>{{ membership.user.name }}</strong>
                                                {% if current_user.is_authenticated and membership.user_id == current_user.id %}
                                                    <!--span class="badge bg-primary ms-2">Me</span-->
                                                {% endif %}
                                                {% if membership.user_id == team.captain_id %}
                                                    <span class="badge bg-success ms-2 rounded-pill">Captain</span>
                                                {% endif %}
                                                {% if membership.willing_to_lead %}
                                                    <span class="badge bg-info text-dark ms-2 rounded-pill">Leg Leader</span>
                                                {% endif %}
                                                {% if permissions.can_manage_team(current_user, team) %}
                                                    <a href="mailto:{{ membership.user.email }}" class="link-secondary text-decoration-none d-block">
                                                        <small>{{ membership.user.email }}</small>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small">
                                            {% if membership.preferred_miles %}
                                                <strong>Miles:</strong> {{ membership.preferred_miles }}<br>
                                            {% endif %}
                                            {% if membership.planned_pace_seconds %}
                                                <strong>Pace:</strong> {{ membership.planned_pace_seconds | format_mm_ss_from_seconds }}/mi<br>
                                            {% endif %}
                                            {% if membership.preferred_station %}
                                                <strong>End Station:</strong> {{ membership.preferred_station }}<br>
                                            {% endif %}
                                            {% if membership.comments %}
                                                <strong>Comments:</strong> {{ membership.comments }}
                                            {% endif %}
                                            {% if current_user.is_authenticated and membership.user_id == current_user.id %}
                                                <a href="{{ url_for('user.my_registration') }}" class="text-primary text-decoration-none">
                                                    <ion-icon name="create-outline" class="me-1"></ion-icon>Edit
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <time datetime="{{ membership.joined_at.isoformat() }}Z" title="{{ membership.joined_at.strftime('%B %-d, %Y at %I:%M %p') }}" class="small text-muted">
                                            {{ membership.joined_at.strftime('%b %-d, %Y') }}
                                        </time>
                                    </td>
                                    {% if permissions.can_manage_team(current_user, team) %}
                                    <td>
                                        {% if membership.user_id != team.captain_id %}
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <ion-icon name="ellipsis-horizontal"></ion-icon>
                                            </button>
                                            <ul class="dropdown-menu">
                                                {% if current_user.is_captain_of(team) %}
                                                <li>
                                                    <button class="dropdown-item" onclick="transferCaptaincy('{{ team.id }}', '{{ membership.user_id }}', '{{ membership.user.name }}')">
                                                        <ion-icon name="crown-outline" class="me-2"></ion-icon>Make Captain
                                                    </button>
                                                </li>
                                                {% endif %}
                                                <li>
                                                    <button class="dropdown-item text-danger" onclick="removeMember('{{ membership.id }}', '{{ membership.user.name }}')">
                                                        <ion-icon name="person-remove-outline" class="me-2"></ion-icon>Remove
                                                    </button>
                                                </li>
                                            </ul>
                                        </div>
                                        {% else %}
                                        <span class="text-muted">—</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                {% endif %}

                                <!-- Withdrawn Team Members -->
                                {% if withdrawn_members %}
                                <tr>
                                    <td colspan="{% if permissions.can_manage_team(current_user, team) %}4{% else %}3{% endif %}" class="fw-bold text-warning px-3 py-2">
                                        Withdrawn ({{ withdrawn_members|length }})
                                    </td>
                                </tr>
                                {% for membership in withdrawn_members %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if membership.user.avatar_url %}
                                                <img src="{{ membership.user.avatar_url }}" alt="{{ membership.user.name }}"
                                                     class="rounded-circle me-3 {% if current_user.is_authenticated and membership.user_id == current_user.id %}border border-2 border-primary{% endif %}" width="40" height="40" style="opacity: 0.6;">
                                            {% endif %}
                                            <div>
                                                <strong class="text-muted">{{ membership.user.name }}</strong>
                                                {% if current_user.is_authenticated and membership.user_id == current_user.id %}
                                                    <!--span class="badge bg-primary ms-2">Me</span-->
                                                {% endif %}
                                                {% if membership.user_id == team.captain_id %}
                                                    <span class="badge bg-success ms-2 rounded-pill">Captain</span>
                                                {% endif %}
                                                {% if membership.willing_to_lead %}
                                                    <span class="badge bg-info text-dark ms-2 rounded-pill">Leg Leader</span>
                                                {% endif %}
                                                {% if permissions.can_manage_team(current_user, team) %}
                                                    <a href="mailto:{{ membership.user.email }}" class="link-secondary text-decoration-none d-block">
                                                        <small>{{ membership.user.email }}</small>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small text-muted">
                                            {% if membership.preferred_miles %}
                                                <strong>Miles:</strong> {{ membership.preferred_miles }}<br>
                                            {% endif %}
                                            {% if membership.planned_pace %}
                                                <strong>Pace:</strong> {{ membership.planned_pace }}/mile<br>
                                            {% endif %}
                                            {% if membership.preferred_station %}
                                                <strong>End Station:</strong> {{ membership.preferred_station }}<br>
                                            {% endif %}
                                            {% if membership.comments %}
                                                <strong>Comments:</strong> {{ membership.comments }}
                                            {% endif %}
                                            {% if current_user.is_authenticated and membership.user_id == current_user.id %}
                                                <a href="{{ url_for('user.my_registration') }}" class="text-primary text-decoration-none">
                                                    <ion-icon name="create-outline" class="me-1"></ion-icon>Edit
                                                </a>
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <time datetime="{{ membership.joined_at.isoformat() }}Z" title="{{ membership.joined_at.strftime('%B %-d, %Y at %I:%M %p') }}" class="small text-muted">
                                            {{ membership.joined_at.strftime('%b %-d, %Y') }}
                                        </time>
                                    </td>
                                    {% if permissions.can_manage_team(current_user, team) %}
                                    <td>
                                        <span class="text-muted">—</span>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                {% endif %}

                                <!-- Removed Team Members (Captain and Admin Only) -->
                                {% if removed_members and (permissions.can_manage_team(current_user, team)) %}
                                <tr>
                                    <td colspan="{% if permissions.can_manage_team(current_user, team) %}4{% else %}3{% endif %}" class="fw-bold text-danger px-3 py-2">
                                        Removed ({{ removed_members|length }})
                                    </td>
                                </tr>
                                {% for membership in removed_members %}
                                <tr class="table-danger-subtle">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if membership.user.avatar_url %}
                                                <img src="{{ membership.user.avatar_url }}" alt="{{ membership.user.name }}"
                                                     class="rounded-circle me-3 {% if current_user.is_authenticated and membership.user_id == current_user.id %}border border-2 border-primary{% endif %}" width="40" height="40" style="opacity: 0.4;">
                                            {% endif %}
                                            <div>
                                                <strong class="text-muted">{{ membership.user.name }}</strong>
                                                {% if current_user.is_authenticated and membership.user_id == current_user.id %}
                                                    <!--span class="badge bg-primary ms-2">Me</span-->
                                                {% endif %}
                                                {% if permissions.can_manage_team(current_user, team) %}
                                                    <a href="mailto:{{ membership.user.email }}" class="link-secondary text-decoration-none d-block">
                                                        <small>{{ membership.user.email }}</small>
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="small text-muted">
                                            {% if membership.preferred_miles %}
                                                <strong>Miles:</strong> {{ membership.preferred_miles }}<br>
                                            {% endif %}
                                            {% if membership.planned_pace %}
                                                <strong>Pace:</strong> {{ membership.planned_pace }}/mile<br>
                                            {% endif %}
                                            {% if membership.preferred_station %}
                                                <strong>End Station:</strong> {{ membership.preferred_station }}<br>
                                            {% endif %}
                                            {% if membership.comments %}
                                                <strong>Comments:</strong> {{ membership.comments }}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <time datetime="{{ membership.joined_at.isoformat() }}Z" title="{{ membership.joined_at.strftime('%B %-d, %Y at %I:%M %p') }}" class="small text-muted">
                                            {{ membership.joined_at.strftime('%b %-d, %Y') }}
                                        </time>
                                    </td>
                                    {% if permissions.can_manage_team(current_user, team) %}
                                    <td>
                                        <span class="text-muted">—</span>
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                {% endif %}

                                {% if active_members|length == 0 and withdrawn_members|length == 0 %}
                                <tr>
                                    <td colspan="{% if permissions.can_manage_team(current_user, team) %}4{% else %}3{% endif %}" class="text-center text-muted p-4">
                                        <ion-icon name="people-outline" style="font-size: 2rem;"></ion-icon>
                                        <p class="mt-2 mb-0">No team members yet. Share the team invite to get started!</p>
                                    </td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {% endif %}
        </div>

        <!-- Captain Actions Card -->
        {% if current_user.is_captain_of(team) and team.status != TeamStatus.CANCELLED %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            Captain Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if team.status not in [TeamStatus.WITHDRAWN, TeamStatus.CANCELLED] %}
                            {% if team.format == TeamFormat.TEAM %}
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-4">
                                        <h6>Team Password</h6>
                                        <p class="text-muted small">Control access to your team by setting or changing the password.            {% if team.has_password %}
                                        <span type="button" class="btn btn-link d-inline-block px-0 text-secondary" onclick="removePassword()">
                                            <small><ion-icon name="lock-open-outline" class="me-1"></ion-icon>Remove Password</small>
                                        </span>
                                        {% endif %}</p>
                                        <form id="password-form" class="mb-2">
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="team_password"
                                                       placeholder="{% if team.has_password %}Enter new password{% else %}Set team password{% endif %}"
                                                       >
                                                <button class="btn btn-outline-primary" type="submit">
                                                    {% if team.has_password %}Update{% else %}Set{% endif %}
                                                </button>
                                            </div>
                                        </form>

                                    </div>
                                        {% if team.format == TeamFormat.TEAM and team.status == TeamStatus.CLOSED %}
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between align-items-start gap-3">
                                            <div>
                                                <h6>Team Registration</h6>
                                                {% if team.status == TeamStatus.CLOSED %}
                                                <p class="text-muted small mb-0">Your team is closed to new registrations. Click to reopen.</p>
                                                {% else %}
                                                <p class="text-muted small mb-0">Close your team to prevent new members from joining.</p>
                                                {% endif %}
                                            </div>
                                            <div class="flex-shrink-0">
                                                {% if team.status == TeamStatus.CLOSED %}
                                                <button class="btn btn-outline-success" onclick="reopenTeam('{{ team.name }}', '{{ team.id }}')">
                                                    <div class="d-flex align-items-center gap-2">
                                                        <ion-icon name="lock-open-outline"></ion-icon>
                                                        <span>Reopen Team</span>
                                                    </div>
                                                </button>
                                                {% else %}
                                                <button class="btn btn-outline-secondary" onclick="closeTeam('{{ team.name }}', '{{ team.id }}')">
                                                    Close Team
                                                </button>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3{% if team.status == TeamStatus.PENDING %} opacity-50{% endif %}">
                                        <div class="d-flex justify-content-between align-items-start gap-3 mb-3">
                                            <div>
                                                <h6>Invite Members</h6>
                                                <p class="text-muted small mb-0">Share this unique link to allow others to join your team directly, bypassing the password.</p>
                                                <small class="text-muted d-block mt-2">Regenerating the link will invalidate the old one.</small>
                                                {% if team.status == TeamStatus.PENDING %}
                                                <p class="text-muted small mb-0"><em>Invite links are disabled while your team is pending approval.</em></p>
                                                {% endif %}
                                            </div>
                                            <div class="flex-shrink-0">
                                                <button class="btn btn-outline-primary" id="generateInviteLinkBtn" onclick="generateInviteLink()" {% if team.status == TeamStatus.PENDING %}disabled{% endif %}>
                                                    {% if team.invite_token %}Regenerate Link{% else %}Generate Link{% endif %}
                                                </button>
                                            </div>
                                        </div>
                                        <div class="input-group mb-2">
                                            <input type="text" class="form-control" id="inviteLink"
                                                   value="{% if team.invite_token %}{{ url_for('user.join_team', invite_token=team.invite_token, _external=True) }}{% else %}Click 'Generate' to create a link.{% endif %}" readonly {% if team.status == TeamStatus.PENDING %}disabled{% endif %}>
                                            <button class="btn btn-outline-secondary" type="button" id="copyInviteLinkBtn" onclick="copyInviteLink()" {% if not team.invite_token or team.status == TeamStatus.PENDING %}disabled{% endif %}>
                                                <ion-icon name="copy-outline"></ion-icon> Copy
                                            </button>
                                        </div>

                                    </div>


                                </div>
                            </div>
                            <hr>
                            {% endif %}
                            <div class="row">
                                <div class="col-12">
                                    <h6>Update Details</h6>
                                    <p class="text-muted small">Update your entry's time estimate and comments.</p>
                                    <form id="update-details-form" class="small">
                                        <div class="mb-3">
                                            <label for="estimated_duration_input" class="form-label">Estimated Duration</label>
                                            <input type="text" class="form-control" id="estimated_duration_input"
                                                   placeholder="HH:MM" value="{{ team.estimated_duration_seconds | format_hh_mm_from_seconds }}" required pattern="^\d{1,2}:\d{2}$" title="Format: HH:MM">
                                        </div>
                                        <div class="mb-3">
                                            <label for="comments_input" class="form-label">Comments</label>
                                            <textarea class="form-control" id="comments_input" rows="3"
                                                      placeholder="Optional comments about your {% if team.format == TeamFormat.SOLO %}entry{% else %}team entry{% endif %}..."
                                                      maxlength="500">{{ team.comments or '' }}</textarea>
                                            <div class="form-text">Optional comments visible to the admin</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="previous_baton_serial_input" class="form-label">Previous Baton Serial</label>
                                            <input type="text" class="form-control" id="previous_baton_serial_input" name="previous_baton_serial" value="{{ team.previous_baton_serial or '' }}" maxlength="12" {% if team.status != TeamStatus.PENDING %}disabled{% endif %}>
                                            <div class="form-text">If you have a baton from a previous year, enter its serial number here.  {% if team.status != TeamStatus.PENDING %}You can't change this after you've paid and your team is approved.

                                            {% endif %}</div>

                                        </div>
                                        <div class="text-end">
                                            <button class="btn btn-outline-primary" type="submit">Save Changes
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <hr>
                        {% endif %}
                        <div class="row">
                            <div class="col-12">
                                <div class="mb-4">
                                    <h6>Captain Notifications</h6>
                                    <p class="text-muted small">Control which email notifications you receive as team captain.</p>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="captain_notifications"
                                               {% if current_user.captain_notifications_enabled %}checked{% endif %}>
                                        <label class="form-check-label" for="captain_notifications">
                                            Receive notifications when new members join or leave the team.
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-start gap-3">
                                    <div>
                                        <h6>Entry Management</h6>
                                        {% if team.status == TeamStatus.WITHDRAWN %}
                                        <p class="text-muted small mb-0">Your {% if team.format == TeamFormat.SOLO %}entry has{% else %}team has{% endif %} been withdrawn. Click to re-enter the event.</p>
                                        {% elif team.status == TeamStatus.PENDING %}
                                        <p class="text-muted small mb-0">Cancel your {% if team.format == TeamFormat.SOLO %}entry{% else %}team{% endif %} registration if you no longer wish to participate.</p>
                                        {% else %}
                                        <p class="text-muted small mb-0">Withdraw your {% if team.format == TeamFormat.SOLO %}entry{% else %}team{% endif %} from the event if needed.</p>
                                        {% endif %}
                                    </div>
                                    <div class="flex-shrink-0">
                                        {% if team.status == TeamStatus.WITHDRAWN %}
                                        <button class="btn btn-outline-success" onclick="unwithdrawTeam('{{ team.name }}', '{{ team.id }}')">
                                            Un-withdraw {% if team.format == TeamFormat.SOLO %}Entry{% else %}Team{% endif %}
                                        </button>
                                        {% elif team.status == TeamStatus.PENDING %}
                                        <button class="btn btn-outline-danger" onclick="cancelTeam('{{ team.name }}', '{{ team.id }}')">
                                            <div class="d-flex align-items-center gap-2">
                                                <ion-icon name="close-circle-outline"></ion-icon>
                                                <span>Cancel {% if team.format == TeamFormat.SOLO %}Entry{% else %}Team{% endif %}</span>
                                            </div>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-warning" onclick="withdrawTeam('{{ team.name }}', '{{ team.id }}')">
                                            Withdraw {% if team.format == TeamFormat.SOLO %}Entry{% else %}Team{% endif %}
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    <script type="module">
        import { membershipAPI, teamAPI, api, Utils, userAPI } from '{{ url_for("static", filename="js/api-client.js") }}';

        // Membership management functions
        window.withdrawMembership = async function(membershipId) {
            if (!confirm('Are you sure you want to withdraw from this team? This action will mark your registration as withdrawn.')) {
                return;
            }

            const result = await membershipAPI.withdrawMembership('{{ team.id }}', membershipId);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to withdraw membership', 'danger');
            }
        };

        window.removeMember = async function(membershipId, memberName) {
            if (!confirm(`Are you sure you want to remove ${memberName} from the team? They will be asked to join another team.`)) {
                return;
            }

            const result = await membershipAPI.removeMember('{{ team.id }}', membershipId);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to remove member', 'danger');
            }
        };

        window.transferCaptaincy = async function(shortId, newCaptainId, newCaptainName) {
            if (!confirm(`Are you sure you want to transfer team captaincy to ${newCaptainName}? You will no longer be the captain of this team.`)) {
                return;
            }

            const result = await membershipAPI.promoteToCaptain(shortId, newCaptainId);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to transfer captaincy', 'danger');
            }
        };

        // Invite link management
        window.copyInviteLink = async function() {
            const linkInput = document.getElementById('inviteLink');
            const success = await Utils.copyToClipboard(linkInput.value);

            if (success) {
                const button = document.getElementById('copyInviteLinkBtn');
                const originalText = button.innerHTML;
                button.innerHTML = '<ion-icon name="checkmark-outline"></ion-icon> Copied!';
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-success');

                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.classList.remove('btn-success');
                    button.classList.add('btn-outline-secondary');
                }, 2000);
            }
        }

        window.generateInviteLink = async function() {
            const generateBtn = document.getElementById('generateInviteLinkBtn');
            const originalBtnHTML = generateBtn.innerHTML;

            api.setButtonLoading(generateBtn, 'Generating...');

            const result = await teamAPI.generateInviteLink('{{ team.id }}');

            if (result.success) {
                const data = result.data;
                const linkInput = document.getElementById('inviteLink');
                const copyBtn = document.getElementById('copyInviteLinkBtn');
                linkInput.value = data.invite_link;
                copyBtn.disabled = false;
                generateBtn.innerHTML = '<ion-icon name="sparkles-outline"></ion-icon> Regenerate Link';

                api.showToast(data.message, 'success');
            } else {
                api.showToast(result.error || 'Failed to generate link', 'danger');
                api.resetButton(generateBtn);
            }
        }

        // Team password management
        window.updateTeamPassword = async function(password) {
            const result = await teamAPI.manageTeamPassword('{{ team.id }}', password);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to update password', 'danger');
            }
        };

        window.removePassword = async function() {
            if (!confirm('Are you sure you want to remove the team password? This will allow anyone to join your team without a password.')) {
                return;
            }

            const result = await teamAPI.manageTeamPassword('{{ team.id }}', null);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to remove password', 'danger');
            }
        };

        // Team management functions
        window.withdrawTeam = async function(teamName, shortId) {
            if (!confirm(`Are you sure you want to withdraw team "${teamName}" from the event?`)) {
                return;
            }

            const result = await teamAPI.withdrawTeam(shortId);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.href = '{{ url_for("main.index") }}';
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to withdraw team', 'danger');
            }
        };

        window.unwithdrawTeam = async function(teamName, shortId) {
            if (!confirm(`Are you sure you want to un-withdraw team "${teamName}" and re-enter the event?`)) {
                return;
            }

            const result = await teamAPI.unwithdrawTeam(shortId);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to un-withdraw team', 'danger');
            }
        };

        // Custom team operations (extend TeamAPI as needed)
        window.cancelTeam = async function(teamName, shortId) {
            if (!confirm(`Are you sure you want to cancel team "${teamName}"? This action is permanent and cannot be undone.`)) {
                return;
            }

            const result = await teamAPI.cancelTeam(shortId);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.href = '{{ url_for("main.index") }}';
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to cancel team', 'danger');
            }
        };

        window.closeTeam = async function(teamName, shortId) {
            if (!confirm(`Are you sure you want to close team "${teamName}" to new registrations?`)) {
                return;
            }

            const result = await teamAPI.closeTeam(shortId);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to close team', 'danger');
            }
        };

        window.reopenTeam = async function(teamName, shortId) {
            if (!confirm(`Are you sure you want to reopen team "${teamName}" for new registrations?`)) {
                return;
            }

            const result = await teamAPI.reopenTeam(shortId);

            if (result.success) {
                api.showToast(result.data.message, 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                api.showToast(result.error || 'Failed to reopen team', 'danger');
            }
        };

        // Notification preferences handler
        const captainNotificationsCheckbox = document.getElementById('captain_notifications');
        if (captainNotificationsCheckbox) {
            captainNotificationsCheckbox.addEventListener('change', async function(e) {
                const enabled = e.target.checked;

                const result = await userAPI.updateNotificationPreferences({
                    captain_notifications_enabled: enabled
                });

                if (result.success) {
                    api.showToast(result.data.message, 'success');
                } else {
                    // Revert checkbox on error
                    e.target.checked = !enabled;
                    api.showToast(result.error || 'Failed to update notification preferences', 'danger');
                }
            });
        }

        // Form submission handlers
        const passwordForm = document.getElementById('password-form');
        if (passwordForm) {
            passwordForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const passwordInput = document.getElementById('team_password');
                const password = passwordInput.value.trim();

                if (!password) {
                    api.showToast('Please enter a password', 'warning');
                    return;
                }

                updateTeamPassword(password);
            });
        }

        // Team details update form
        const updateDetailsForm = document.getElementById('update-details-form');
        if (updateDetailsForm) {
            updateDetailsForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const estimatedDurationInput = document.getElementById('estimated_duration_input');
                const estimatedDuration = estimatedDurationInput.value.trim();
                const commentsInput = document.getElementById('comments_input');
                const comments = commentsInput.value.trim();
                const previousBatonSerialInput = document.getElementById('previous_baton_serial_input');
                const previousBatonSerial = previousBatonSerialInput.value.trim();

                if (!estimatedDuration) {
                    api.showToast('Please enter an estimated duration.', 'warning');
                    return;
                }

                // Basic regex validation for HH:MM using shared utility
                if (!Utils.validateTime(estimatedDuration)) {
                    api.showToast('Estimated duration must be in HH:MM format (e.g., 05:30 or 12:00).', 'warning');
                    return;
                }

                const result = await teamAPI.updateTeamDetails('{{ team.id }}', {
                    estimated_duration: estimatedDuration,
                    comments: comments,
                    previous_baton_serial: previousBatonSerial
                });

                if (result.success) {
                    api.showToast(result.data.message, 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    api.showToast(result.error || 'Failed to update team details', 'danger');
                }
            });
        }
    </script>
{% endblock %}