{% extends "base.html" %}

{% block title %}Join Team - {{ super() }}{% endblock %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0 d-flex align-items-center">
                        {% if mode == 'view' %}
                            View Registration
                        {% elif mode == 'edit' %}
                            Edit Registration
                        {% else %}
                            Join Team
                        {% endif %}
                    </h3>
                    {% if mode == 'view' and existing_membership %}
                    <div class="d-flex align-items-center">
                        <span class="text-end me-2">
                            <div class="fw-bold">{{ existing_membership.user.name }}</div>
                        </span>
                        <img src="{{ existing_membership.user.avatar_url or url_for('static', filename='images/default_profile.png') }}" alt="Profile image of {{ existing_membership.user.name }}" class="rounded-circle" style="width: 40px; height: 40px; object-fit: cover;">
                    </div>
                    {% endif %}
                </div>
                <div class="card-body">
                    <div id="alert-container"></div>

                    {% if pending_captain_team %}
                    <div class="alert alert-info mb-4" role="alert">
                        <ion-icon name="information-circle-outline" class="me-1"></ion-icon><strong>Welcome, Captain!</strong> Please complete your preferences below to finalize your team setup.
                    </div>
                    {% endif %}

                    {% if mode == 'preview' %}
                    <div class="alert alert-info mb-4" role="alert">
                        <ion-icon name="information-circle-outline" class="me-1"></ion-icon>
                        <a href="{{ url_for('auth.login') }}?next={{ url_for('user.create_team') }}" class="alert-link">Sign in</a> to join a team.
                    </div>
                    {% elif mode == 'edit' %}
                        {% set is_form_disabled = (existing_team and existing_team.status in [TeamStatus.CANCELLED, TeamStatus.WITHDRAWN]) or (existing_membership and existing_membership.status in [TeamMembershipStatus.REMOVED, TeamMembershipStatus.WITHDRAWN]) %}

                        {% if existing_team and existing_team.status == TeamStatus.WITHDRAWN %}
                        <div class="alert alert-danger" role="alert">
                            <ion-icon name="warning" class="me-2"></ion-icon>
                            <strong>Team has been withdrawn.</strong><br>
                            The team "{{ existing_team.name }}" has been withdrawn from the event. You cannot edit your preferences or participate with this team anymore.
                            <a href="{{ url_for('user.join_team') }}" class="alert-link">Join a different team</a> to continue participating.
                        </div>
                        {% elif existing_team and existing_team.status == TeamStatus.CANCELLED %}
                        <div class="alert alert-danger" role="alert">
                            <ion-icon name="close-circle" class="me-2"></ion-icon>
                            <strong>Team has been cancelled.</strong><br>
                            The team "{{ existing_team.name }}" has been cancelled from the event. You cannot edit your preferences or participate with this team anymore.
                            <a href="{{ url_for('user.join_team') }}" class="alert-link">Join a different team</a> to continue participating.
                        </div>
                        {% elif existing_membership and existing_membership.status == TeamMembershipStatus.REMOVED %}
                        <div class="alert alert-danger" role="alert">
                            <ion-icon name="close-circle" class="me-2"></ion-icon>
                            <strong>You have been removed from this team.</strong><br>
                            The team captain has removed you from team "{{ existing_team.name }}". You cannot edit your preferences or participate with this team anymore.
                            <a href="{{ url_for('user.join_team') }}" class="alert-link">Join a different team</a> to continue participating.
                        </div>
                        {% elif existing_membership and existing_membership.status == TeamMembershipStatus.WITHDRAWN %}
                        <div class="alert alert-warning" role="alert">
                            <ion-icon name="close-circle" class="me-2"></ion-icon>
                            <strong>Your registration has been withdrawn.</strong><br>
                            You have withdrawn from team "{{ existing_team.name }}". Your registration preferences are shown below for reference, but cannot be edited while withdrawn.
                            You can either re-join this team using the button below, or <a href="{{ url_for('user.join_team') }}" class="alert-link">join a different team</a>.
                        </div>
                        {% endif %}
                    {% elif mode == 'switch' %}
                        {% if existing_membership and existing_membership.status == TeamMembershipStatus.REMOVED %}
                        <div class="alert alert-danger" role="alert">
                            <ion-icon name="warning" class="me-2"></ion-icon>
                            <strong>You have been removed from team "{{ existing_team.name }}".</strong><br>
                            The team captain has removed you from this team. Please select a different team below to continue participating.
                        </div>
                        {% else %}
                        <div class="alert alert-warning" role="alert">
                            <ion-icon name="warning" class="me-2"></ion-icon>
                            <strong>You're currently on team "{{ existing_team.name }}".</strong><br>
                            Joining a different team will immediately remove you from "{{ existing_team.name }}".
                        </div>
                        {% endif %}
                    {% endif %}

                    {% if error_message %}
                    <div class="alert alert-warning" role="alert">
                        <ion-icon name="warning" class="me-2"></ion-icon>
                        {{ error_message }}
                    </div>
                    {% elif (not teams or (existing_team and teams|selectattr('id', 'ne', existing_team.id)|list|length == 0)) and mode != 'edit' and mode != 'view' and not pending_captain_team and not invited_team %}
                    <div class="text-center py-4 text-muted">
                        <ion-icon name="people-outline" style="font-size: 2rem; opacity: 0.6;"></ion-icon>
                        <p class="mt-2 mb-2">No teams are currently open for joining.</p>
                        <p class="mb-0"><a href="{{ url_for('user.create_team') }}">Create your own team</a> to get started.</p>
                    </div>
                    {% else %}

                    <form id="join-team-form"{% if mode == 'preview' %} class="opacity-75"{% endif %}>
                        {% set pre_selected_team = invited_team or pending_captain_team or existing_team %}
                        {% set is_team_selection_disabled = pre_selected_team or mode in ['preview', 'view', 'edit'] %}

                        {% if invited_team %}
                            <input type="hidden" name="invite_token" value="{{ request.args.get('invite_token') }}">
                        {% endif %}

                        {# This hidden input ensures the team_id is submitted when the select is disabled #}
                        {% if is_team_selection_disabled and pre_selected_team %}
                            <input type="hidden" name="team_id" value="{{ pre_selected_team.id }}">
                        {% endif %}

                        <div class="mb-3">
                            <label for="team_id" class="form-label">
                                <ion-icon name="flag" class="me-1"></ion-icon>
                                Team
                                {% if not is_team_selection_disabled %}<span class="text-danger">*</span>{% endif %}
                            </label>
                            <select class="form-select" id="team_id" name="team_id" required {% if is_team_selection_disabled %}disabled{% endif %}>
                                {% if pre_selected_team %}
                                    <option value="{{ pre_selected_team.id }}" selected>
                                        {{ pre_selected_team.name }}
                                        {% if pre_selected_team.captain %}(Captain: {{ pre_selected_team.captain.name }}){% endif %}
                                        {% if pre_selected_team.has_password %}<ion-icon name="lock-closed" class="ms-1"></ion-icon>{% endif %}
                                    </option>
                                {% else %}
                                    <option value="">Choose a team to join...</option>
                                    {% for team in teams %}
                                        {# In 'switch' mode, the existing_team is defined but we want to show other teams #}
                                        {% if not existing_team or team.id != existing_team.id %}
                                            <option value="{{ team.id }}" data-password-required="{{ 'true' if team.has_password else 'false' }}">
                                                {{ team.name }} (Captain: {{ team.captain.name }})
                                                {% if team.has_password %}<ion-icon name="lock-closed" class="ms-1"></ion-icon>{% endif %}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </select>
                            {% if invited_team %}
                                <div class="form-text">You were invited to join this team. Fill out your preferences below.</div>
                            {% elif not is_team_selection_disabled %}
                                <div class="form-text">Select from available "Team" format teams</div>
                            {% endif %}
                        </div>

                        {# The password section should only show when the user can actually select a team #}
                        {% if not is_team_selection_disabled %}
                        <div class="mb-3" id="password-section" style="display: none;">
                            <label for="team_password" class="form-label">
                                <ion-icon name="key" class="me-1"></ion-icon>
                                Team Password <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="team_password" name="team_password"{% if mode == 'preview' %} disabled{% endif %}>
                            <div class="form-text">This team requires a password to join</div>
                        </div>
                        {% endif %}



                        <div class="mb-3">
                            <label for="preferred_miles" class="form-label">
                                <ion-icon name="footsteps" class="me-1"></ion-icon>
                                How many miles would you like to run? <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" id="preferred_miles" name="preferred_miles"
                                   min="0.1" max="36" step="0.1" required {% if (mode == 'edit' or mode == 'view') and existing_membership %}value="{{ existing_membership.preferred_miles }}"{% elif mode == 'preview' %}placeholder="Enter miles you'd like to run"{% endif %} {% if is_form_disabled or mode == 'preview' or mode == 'view' %}disabled{% endif %}>
                            <div class="form-text">Enter a number between 0.1 and 36</div>
                        </div>

                        <div class="mb-3">
                            <label for="planned_pace" class="form-label">
                                <ion-icon name="speedometer" class="me-1"></ion-icon>
                                What pace per mile would you run your preferred distance? <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="planned_pace" name="planned_pace"
                                   placeholder="9:30" pattern="^\d{1,2}:\d{2}$" required {% if (mode == 'edit' or mode == 'view') and existing_membership %}value="{{ existing_membership.planned_pace_seconds | format_mm_ss_from_seconds }}"{% endif %} {% if is_form_disabled or mode == 'preview' or mode == 'view' %}disabled{% endif %}>
                            <div class="form-text">Format: MM:SS (e.g., 09:30 for 9 minutes 30 seconds per mile). Your captain will adjust times to account for the elevation and street conditions of each leg.</div>
                        </div>

                        <div class="mb-3">
                            <label for="preferred_station" class="form-label">
                                <ion-icon name="train" class="me-1"></ion-icon>
                                Which station is closest to where you'd like to finish?
                            </label>
                            <select class="form-select" id="preferred_station" name="preferred_station" {% if is_form_disabled or mode == 'preview' or mode == 'view' %}disabled{% endif %}>
                                <option value="">No Preference</option>
                                {% for station in stations %}
                                <option value="{{ station }}" {% if (mode == 'edit' or mode == 'view') and existing_membership and existing_membership.preferred_station == station %}selected{% endif %}>{{ station }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Choose the station closest to where you'd like to stop running.</div>
                        </div>

                         <div class="mb-3">
                            <label for="willing_to_lead" class="form-label">
                                <ion-icon name="compass" class="me-1"></ion-icon>
                                Are you willing to lead your legs? <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="willing_to_lead" name="willing_to_lead" required {% if is_form_disabled or mode == 'preview' or mode == 'view' %}disabled{% endif %}>
                                <option value="">Select...</option>
                                <option value="yes" {% if (mode == 'edit' or mode == 'view') and existing_membership and existing_membership.willing_to_lead %}selected{% endif %}>Yes</option>
                                <option value="no" {% if (mode == 'edit' or mode == 'view') and existing_membership and not existing_membership.willing_to_lead %}selected{% endif %}>No</option>
                            </select>
                            <div class="form-text">Say "yes" if you're happy/confident to navigate. This only matters if your captain is scheduling more than one person per leg.</div>
                        </div>

                        <div class="mb-4">
                            <label for="comments" class="form-label">
                                <ion-icon name="chatbubble-ellipses" class="me-1"></ion-icon>
                                Any notes or comments for scheduling?
                            </label>
                            <textarea class="form-control" id="comments" name="comments" rows="3"
                                      placeholder="Let your captain and team mates know if you have hard constraints that would prevent your participation..." {% if is_form_disabled or mode == 'preview' or mode == 'view' %}disabled{% endif %}>{% if (mode == 'edit' or mode == 'view') and existing_membership %}{{ existing_membership.comments or '' }}{% endif %}</textarea>
                            <div class="form-text">Share any scheduling constraints, preferences, or other relevant information.</div>
                        </div>



                        {% if mode != 'edit' and mode != 'view' %}
                        <div class="mb-4">
                            <h5 class="mb-3">
                                <ion-icon name="document-text" class="me-2"></ion-icon>
                                Waiver and Release
                            </h5>
                            <div class="card">
                                <div class="card-body card-text text-muted overflow-auto" style="max-height: 300px">
                                    {% include '_waiver.html' %}
                                </div>
                            </div>
                            <div class="form-check mt-3 ms-lg-4">
                                <input class="form-check-input" type="checkbox" id="waiver_agreed" name="waiver_agreed" required{% if mode == 'preview' %} disabled{% endif %}>
                                <label class="form-check-label" for="waiver_agreed">
                                    <span class="text-danger">*</span> I have read and understood the terms and conditions of the waiver, and I agree to abide by them
                                </label>
                            </div>
                        </div>
                        {% else %}
                        <input type="hidden" name="waiver_agreed" value="on">
                        {% endif %}

                        <div class="mb-4">
                            <div class="d-flex align-items-center">
                                <ion-icon name="mail" class="me-2"></ion-icon>
                                <div class="form-check mb-0">
                                    <input class="form-check-input" type="checkbox" id="email_opt_in" name="email_opt_in" value="true" {% if (mode == 'edit' or mode == 'view') and user.email_opt_in %}checked{% endif %} {% if is_form_disabled or mode == 'preview' or mode == 'view' %}disabled{% endif %}>
                                    <label class="form-check-label" for="email_opt_in">
                                       Email me when the next LRR happens.
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            {% if mode == 'edit' %}
                                {% if existing_membership and existing_membership.status == TeamMembershipStatus.WITHDRAWN %}
                                <button type="button" class="btn btn-success" id="unwithdraw-btn" onclick="unwithdrawMembership('{{ existing_membership.user.id }}')">
                                    Re-join Team
                                </button>
                                {% elif not is_form_disabled %}
                                    {% if existing_membership %}
                                        {% if existing_membership.status == TeamMembershipStatus.REMOVED %}
                                        <!-- No buttons for removed users - they need to join a different team -->
                                        {% else %}
                                        <button type="button" class="btn btn-outline-warning me-md-2" onclick="withdrawMembership('{{ existing_membership.user.id }}')">
                                            Withdraw from Team
                                        </button>
                                        <button type="submit" class="btn btn-primary" id="submit-btn">
                                            Update Preferences
                                        </button>
                                        {% endif %}
                                    {% else %}
                                        {# Captain of a pending team creating their preferences for the first time #}
                                        <button type="submit" class="btn btn-primary" id="submit-btn">
                                            Save Preferences
                                        </button>
                                    {% endif %}
                                {% endif %}
                            {% elif mode == 'preview' or (mode != 'edit' and mode != 'view') %}
                            <button type="submit" class="btn btn-success" id="submit-btn" {% if mode == 'preview' %}disabled{% endif %}>
                                <ion-icon name="person-add" class="me-1"></ion-icon>
                                {% if mode == 'preview' %}Join Team{% else %}Join Team{% endif %}
                            </button>
                            {% endif %}
                        </div>
                    </form>

                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script type="module">
import { membershipAPI, teamAPI, api, Utils } from '{{ url_for("static", filename="js/api-client.js") }}';

// Handle team selection changes to show/hide password field
const teamSelect = document.getElementById('team_id');
const passwordSection = document.getElementById('password-section');
const passwordInput = document.getElementById('team_password');

if (teamSelect && passwordSection) {
    function updatePasswordField() {
        const selectedOption = teamSelect.options[teamSelect.selectedIndex];
        const passwordRequired = selectedOption.getAttribute('data-password-required') === 'true';

        if (passwordRequired && teamSelect.value) {
            passwordSection.style.display = 'block';
            passwordInput.required = true;
        } else {
            passwordSection.style.display = 'none';
            passwordInput.required = false;
            passwordInput.value = '';
        }
    }

    teamSelect.addEventListener('change', updatePasswordField);

    // Check on page load in case team is pre-selected
    updatePasswordField();
}

// Format pace input as user types using shared utility
const plannedPaceInput = document.getElementById('planned_pace');
if (plannedPaceInput) {
    Utils.formatTimeInput(plannedPaceInput, 99);
}

document.getElementById('join-team-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('submit-btn');
    const alertContainer = document.getElementById('alert-container');

    // Clear previous alerts
    api.clearAlerts(alertContainer);

    // Show loading state
    {% if mode == 'edit' %}
        api.setButtonLoading(submitBtn, 'Updating...');
    {% else %}
        api.setButtonLoading(submitBtn, 'Joining...');
    {% endif %}

    let result;
    {% if mode == 'edit' %}
        result = await membershipAPI.updateMembership(new FormData(this));
    {% else %}
        result = await membershipAPI.joinTeam(new FormData(this));
    {% endif %}

    if (result.success) {
        // Show success toast
        api.showToast(result.data.message, 'success');

        // Redirect after a short delay
        api.redirectAfterDelay(result.data.redirect_url || '{{ url_for("main.index") }}');
    } else {
        // Show error message
        api.showAlert(alertContainer, 'danger', result.error || 'Failed to submit form', 'warning');
        // Reset button
        api.resetButton(submitBtn);
    }
});

// Membership management functions using shared API client
window.withdrawMembership = async function(membershipId) {
    if (!confirm('Are you sure you want to withdraw from this team? This action will mark your registration as withdrawn.')) {
        return;
    }

    const result = await membershipAPI.withdrawMembership('{{ existing_team.id if existing_team else "" }}', membershipId);

    if (result.success) {
        // Show success alert
        api.showAlert('alert-container', 'success', result.data.message, 'checkmark-circle');
        // Redirect after a short delay
        api.redirectAfterDelay('{{ url_for("main.index") }}');
    } else {
        // Show error alert
        api.showAlert('alert-container', 'danger', result.error || 'Failed to withdraw membership', 'warning');
    }
};

window.unwithdrawMembership = async function(membershipId) {
    if (!confirm('Are you sure you want to re-join this team? This will reactivate your membership.')) {
        return;
    }

    const unwithdrawBtn = document.getElementById('unwithdraw-btn');
    const alertContainer = document.getElementById('alert-container');

    // Show loading state using shared API client
    api.setButtonLoading(unwithdrawBtn, 'Re-joining...');

    const result = await membershipAPI.unwithdrawMembership('{{ existing_team.id if existing_team else "" }}', membershipId);

    if (result.success) {
        // Show success alert
        api.showAlert(alertContainer, 'success', result.data.message, 'checkmark-circle');
        // Redirect after a short delay to refresh the page
        api.redirectAfterDelay(window.location.href);
    } else {
        // Show error alert
        api.showAlert(alertContainer, 'danger', result.error || 'Failed to re-join team', 'warning');
        // Reset button
        api.resetButton(unwithdrawBtn);
    }
};

window.unwithdrawTeam = async function(teamName, shortId) {
    if (!confirm(`Are you sure you want to un-withdraw team "${teamName}" and re-enter the event?`)) {
        return;
    }

    const result = await teamAPI.unwithdrawTeam(shortId);

    if (result.success) {
        // Show success alert
        api.showAlert('alert-container', 'success', result.data.message, 'checkmark-circle');
        // Redirect after a short delay
        api.redirectAfterDelay(window.location.href);
    } else {
        // Show error alert
        api.showAlert('alert-container', 'danger', result.error || 'Failed to un-withdraw team', 'warning');
    }
};
</script>
{% endblock %}