<!DOCTYPE html>
<html lang="en">
<head>
    {% include '_head.html' %}
</head>
<body>


<div class="container mt-4">
{% include '_navbar.html' %}
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <ion-icon name="add-circle" class="me-2"></ion-icon>
                        Create New Team
                    </h3>
                </div>
                <div class="card-body">
                    <div id="alert-container"></div>

                    <form id="create-team-form">
                        <div class="mb-3">
                            <label for="format" class="form-label">
                                <ion-icon name="options" class="me-1"></ion-icon>
                                Format <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="format" name="format" required>
                                <option value="">Select format...</option>
                                <option value="Solo">Solo</option>
                                <option value="Team">Team</option>
                            </select>
                            <div class="form-text">Choose whether this is a solo or team effort</div>
                        </div>

                        <div class="mb-3" id="team-name-section">
                            <label for="team_name" class="form-label">
                                <ion-icon name="flag" class="me-1"></ion-icon>
                                Team Name <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="team_name" name="team_name" required maxlength="255">
                            <div class="form-text" id="team-name-help">Choose a unique name for your team</div>
                        </div>

                        <div class="mb-3">
                            <label for="estimated_duration" class="form-label">
                                <ion-icon name="time" class="me-1"></ion-icon>
                                Estimated Duration <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="estimated_duration" name="estimated_duration"
                                   placeholder="1:30" pattern="^\d{1,2}:\d{2}$" required>
                            <div class="form-text">Format: HH:MM (e.g., 1:30 for 1 hour 30 minutes)</div>
                        </div>

                        <div class="mb-3" id="password-section" style="display: none;">
                            <label for="password" class="form-label">
                                <ion-icon name="lock-closed" class="me-1"></ion-icon>
                                Team Password
                            </label>
                            <input type="password" class="form-control" id="password" name="password" maxlength="255">
                            <div class="form-text">Optional: Set a password to require for joining this team</div>
                        </div>

                        <div class="mb-3">
                            <label for="comments" class="form-label">
                                <ion-icon name="chatbubble" class="me-1"></ion-icon>
                                Comments
                            </label>
                            <textarea class="form-control" id="comments" name="comments" rows="3"
                                      placeholder="Any additional information about your team..."></textarea>
                            <div class="form-text">Optional: Anything you want the admin to know about your entry.</div>
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="has_baton" name="has_baton" value="true">
                                <label class="form-check-label" for="has_baton">
                                    <ion-icon name="flag-outline" class="me-1"></ion-icon>
                                    I will bring a Light Rail Relay baton from a previous year.
                                </label>
                            </div>
                        </div>

                        <div class="mb-3" id="baton-fee-warning" style="display: none;">
                            <div class="alert alert-info">
                                <ion-icon name="cash-outline" class="me-2"></ion-icon>
                                A $16 charge for a new baton will be required for team approval.
                            </div>
                        </div>

                        <div class="mb-4" id="email-opt-in-section" style="display: none;">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email_opt_in" name="email_opt_in" value="true" {% if current_user.email_opt_in %}checked{% endif %}>
                                <label class="form-check-label" for="email_opt_in">
                                    <ion-icon name="mail-outline" class="me-1"></ion-icon>
                                    Opt-in for information about the next event.
                                </label>
                                <div class="form-text">We'll only email you about the next official running event.</div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <ion-icon name="add-circle" class="me-1"></ion-icon>
                                Create Team
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { teamAPI, api, Utils } from '{{ url_for("static", filename="js/api-client.js") }}';

function updateFormForFormat() {
    const formatSelect = document.getElementById('format');
    const formatValue = formatSelect.value;
    const teamNameInput = document.getElementById('team_name');
    const teamNameLabel = document.querySelector('label[for="team_name"]');
    const teamNameHelp = document.getElementById('team-name-help');
    const passwordSection = document.getElementById('password-section');
    const emailOptInSection = document.getElementById('email-opt-in-section');

    // Find the text node to update the label text without removing the icon
    const labelTextNode = Array.from(teamNameLabel.childNodes).find(node => node.nodeType === Node.TEXT_NODE && node.textContent.trim());

    if (formatValue === 'Solo') {
        // Set team name to user's name and make it readonly
        teamNameInput.value = '{{ user.name }}';
        teamNameInput.readOnly = true;
        teamNameInput.classList.add('disabled');
        if (labelTextNode) labelTextNode.textContent = ' Name ';
        teamNameHelp.textContent = 'For solo entries, your name will be used automatically';
        // Hide password section for solo teams
        passwordSection.style.display = 'none';
        document.getElementById('password').value = '';
        // Show email opt-in section for solo entries
        emailOptInSection.style.display = 'block';
    } else if (formatValue === 'Team') {
        // Enable team name input
        if (teamNameInput.readOnly) teamNameInput.value = ''; // Clear only if switching from Solo
        teamNameInput.readOnly = false;
        teamNameInput.classList.remove('disabled');
        if (labelTextNode) labelTextNode.textContent = ' Team Name ';
        teamNameHelp.textContent = 'Choose a unique name for your team';
        // Show password section for team format
        passwordSection.style.display = 'block';
        // Hide email opt-in section for team entries (they go to preferences)
        emailOptInSection.style.display = 'none';
    } else {
        // Reset when no format selected
        if (teamNameInput.readOnly) teamNameInput.value = ''; // Clear only if switching from Solo
        teamNameInput.readOnly = false;
        teamNameInput.classList.remove('disabled');
        if (labelTextNode) labelTextNode.textContent = ' Team Name ';
        teamNameHelp.textContent = 'Choose a unique name for your team';
        // Hide password section when no format selected
        passwordSection.style.display = 'none';
        document.getElementById('password').value = '';
        // Hide email opt-in section when no format selected
        emailOptInSection.style.display = 'none';
    }
}

function updateBatonFeeWarning() {
    const hasBatonCheckbox = document.getElementById('has_baton');
    const batonFeeWarning = document.getElementById('baton-fee-warning');
    if (hasBatonCheckbox && batonFeeWarning) {
        batonFeeWarning.style.display = hasBatonCheckbox.checked ? 'none' : 'block';
    }
}

// Run on page load to handle browser auto-fill/refresh state
document.addEventListener('DOMContentLoaded', () => {
    updateFormForFormat();
    updateBatonFeeWarning();
});

// Also run on change for user interaction
document.getElementById('format').addEventListener('change', updateFormForFormat);

document.getElementById('has_baton').addEventListener('change', updateBatonFeeWarning);

document.getElementById('create-team-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('submit-btn');
    const alertContainer = document.getElementById('alert-container');

    // Clear previous alerts
    api.clearAlerts(alertContainer);

    // Show loading state
    api.setButtonLoading(submitBtn, 'Creating...');

    const result = await teamAPI.createTeam(new FormData(this));

    if (result.success) {
        // Show success message
        api.showAlert(alertContainer, 'success', result.data.message, 'checkmark-circle');

        // Redirect after a short delay
        api.redirectAfterDelay(result.data.redirect_url || '{{ url_for("join_team") }}');
    } else {
        // Show error message
        api.showAlert(alertContainer, 'danger', result.error || 'Failed to create team', 'warning');
        // Reset button
        api.resetButton(submitBtn);
    }
});

// Format duration input as user types using shared utility
const estimatedDurationInput = document.getElementById('estimated_duration');
if (estimatedDurationInput) {
    Utils.formatTimeInput(estimatedDurationInput, 24); // Max 24 hours
}
</script>

{% include '_footer.html' %}
</body>
</html>