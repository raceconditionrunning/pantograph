<!DOCTYPE html>
<html lang="en">
<head>
    {% include '_head.html' %}
    <title>Join Team - Relay Photo Collector</title>
</head>
<body>



<div class="container mt-4">
    {% include '_navbar.html' %}
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <ion-icon name="person-add" class="me-2"></ion-icon>
                        {% if mode == 'edit' %}
                            Edit Registration
                        {% else %}
                            Join a Team
                        {% endif %}
                    </h3>
                </div>
                <div class="card-body">
                    <div id="alert-container"></div>

                    {% if mode == 'edit' %}
                        {% set is_form_disabled = (existing_team and existing_team.status == 'cancelled') or (existing_team and existing_team.status == 'withdrawn') or (existing_membership and existing_membership.status == 'removed') or (existing_membership and existing_membership.status == 'withdrawn') %}

                        {% if existing_team and existing_team.status == 'withdrawn' %}
                        <div class="alert alert-danger" role="alert">
                            <ion-icon name="warning" class="me-2"></ion-icon>
                            <strong>Team has been withdrawn.</strong><br>
                            The team "{{ existing_team.name }}" has been withdrawn from the event. You cannot edit your preferences or participate with this team anymore.
                            <a href="{{ url_for('join_team') }}" class="alert-link">Join a different team</a> to continue participating.
                        </div>
                        {% elif existing_team and existing_team.status == 'cancelled' %}
                        <div class="alert alert-danger" role="alert">
                            <ion-icon name="close-circle" class="me-2"></ion-icon>
                            <strong>Team has been cancelled.</strong><br>
                            The team "{{ existing_team.name }}" has been cancelled from the event. You cannot edit your preferences or participate with this team anymore.
                            <a href="{{ url_for('join_team') }}" class="alert-link">Join a different team</a> to continue participating.
                        </div>
                        {% elif existing_membership and existing_membership.status == 'removed' %}
                        <div class="alert alert-danger" role="alert">
                            <ion-icon name="close-circle" class="me-2"></ion-icon>
                            <strong>You have been removed from this team.</strong><br>
                            The team captain has removed you from team "{{ existing_team.name }}". You cannot edit your preferences or participate with this team anymore.
                            <a href="{{ url_for('join_team') }}" class="alert-link">Join a different team</a> to continue participating.
                        </div>
                        {% elif existing_membership and existing_membership.status == 'withdrawn' %}
                        <div class="alert alert-warning" role="alert">
                            <ion-icon name="close-circle" class="me-2"></ion-icon>
                            <strong>Your registration has been withdrawn.</strong><br>
                            You have withdrawn from team "{{ existing_team.name }}". Your registration preferences are shown below for reference, but cannot be edited while withdrawn.
                            You can either re-join this team using the button below, or <a href="{{ url_for('join_team') }}" class="alert-link">join a different team</a>.
                        </div>
                        {% else %}
                        <div class="alert alert-info" role="alert">
                            <ion-icon name="information-circle" class="me-2"></ion-icon>
                            You are editing your registration for team "{{ existing_team.name }}".
                        </div>
                        {% endif %}
                    {% elif mode == 'switch' %}
                        {% if existing_membership and existing_membership.status == 'removed' %}
                        <div class="alert alert-danger" role="alert">
                            <ion-icon name="warning" class="me-2"></ion-icon>
                            <strong>You have been removed from team "{{ existing_team.name }}".</strong><br>
                            The team captain has removed you from this team. Please select a different team below to continue participating.
                        </div>
                        {% else %}
                        <div class="alert alert-warning" role="alert">
                            <ion-icon name="warning" class="me-2"></ion-icon>
                            <strong>You're currently on team "{{ existing_team.name }}".</strong><br>
                            Joining a different team will immediately remove you from "{{ existing_team.name }}".
                        </div>
                        {% endif %}
                    {% endif %}

                    {% if error_message %}
                    <div class="alert alert-warning" role="alert">
                        <ion-icon name="warning" class="me-2"></ion-icon>
                        {{ error_message }}
                    </div>
                    {% elif (not teams or (existing_team and teams|selectattr('id', 'ne', existing_team.id)|list|length == 0)) and mode != 'edit' and not pending_captain_team and not invited_team %}
                    <div class="alert alert-info" role="alert">
                        <ion-icon name="information-circle" class="me-2"></ion-icon>
                        No teams are currently open for joining. Why not <a href="{{ url_for('create_team') }}">create one</a>?
                    </div>
                    {% else %}

                    <form id="join-team-form">
                        {% if invited_team %}
                        {# User arrived via an invite link #}
                        <input type="hidden" name="invite_token" value="{{ request.args.get('invite_token') }}">
                        <input type="hidden" name="team_id" value="{{ invited_team.id }}">
                        <div class="mb-3">
                            <label class="form-label">
                                <ion-icon name="flag" class="me-1"></ion-icon>
                                Team
                            </label>
                            <p class="form-control-plaintext ps-2"><strong>{{ invited_team.name }}</strong> (Captain: {{ invited_team.captain.name }})</p>
                            <div class="form-text">You were invited to join this team. Fill out your preferences below.</div>
                        </div>

                        {% elif pending_captain_team %}
                        {# Captain is filling out preferences for their newly created, pending team #}
                        <input type="hidden" name="team_id" value="{{ pending_captain_team.id }}">
                        <div class="mb-3">
                            <label class="form-label">
                                <ion-icon name="flag" class="me-1"></ion-icon>
                                Your Team
                            </label>
                            <p class="form-control-plaintext ps-2"><strong>{{ pending_captain_team.name }}</strong></p>
                            <div class="alert alert-info mt-2">Your team is pending admin approval. Please fill out your preferences below to complete your registration.</div>
                        </div>


                        {% elif mode != 'edit' %}
                        <div class="mb-3">
                            <label for="team_id" class="form-label">
                                <ion-icon name="flag" class="me-1"></ion-icon>
                                Select Team <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="team_id" name="team_id" required>
                                <option value="">Choose a team to join...</option>
                                {% for team in teams %}
                                {% if not existing_team or team.id != existing_team.id %}
                                <option value="{{ team.id }}" data-password-required="{{ 'true' if team.password else 'false' }}">
                                    {{ team.name }} (Captain: {{ team.captain.name }})
                                    {% if team.password %}<ion-icon name="lock-closed" class="ms-1"></ion-icon>{% endif %}
                                </option>
                                {% endif %}
                                {% endfor %}
                            </select>
                            <div class="form-text">Select from available "Team" format teams</div>
                        </div>

                        <div class="mb-3" id="password-section" style="display: none;">
                            <label for="team_password" class="form-label">
                                <ion-icon name="key" class="me-1"></ion-icon>
                                Team Password <span class="text-danger">*</span>
                            </label>
                            <input type="password" class="form-control" id="team_password" name="team_password">
                            <div class="form-text">This team requires a password to join</div>
                        </div>
                        {% else %}
                        <input type="hidden" name="team_id" value="{{ existing_team.id }}">
                        {% endif %}

                        <div class="mb-3">
                            <label for="willing_to_lead" class="form-label">
                                <ion-icon name="compass" class="me-1"></ion-icon>
                                Are you willing to lead your legs? <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="willing_to_lead" name="willing_to_lead" required {% if is_form_disabled %}disabled{% endif %}>
                                <option value="">Select...</option>
                                <option value="yes" {% if mode == 'edit' and existing_membership and existing_membership.willing_to_lead %}selected{% endif %}>Yes</option>
                                <option value="no" {% if mode == 'edit' and existing_membership and not existing_membership.willing_to_lead %}selected{% endif %}>No</option>
                            </select>
                            <div class="form-text">Say "yes" if you're confident you can manage navigation and time keeping. This only matters if your captain is scheduling more than one person per leg.</div>
                        </div>

                        <div class="mb-3">
                            <label for="preferred_miles" class="form-label">
                                <ion-icon name="walk" class="me-1"></ion-icon>
                                How many miles would you like to run? <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" id="preferred_miles" name="preferred_miles"
                                   min="0.1" max="36" step="0.1" required {% if mode == 'edit' and existing_membership %}value="{{ existing_membership.preferred_miles }}"{% endif %} {% if is_form_disabled %}disabled{% endif %}>
                            <div class="form-text">Enter a number between 0.1 and 36</div>
                        </div>

                        <div class="mb-3">
                            <label for="planned_pace" class="form-label">
                                <ion-icon name="speedometer" class="me-1"></ion-icon>
                                What pace per mile would you plan to run your preferred distance? <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="planned_pace" name="planned_pace"
                                   placeholder="7:30" pattern="^\d{1,2}:\d{2}$" required {% if mode == 'edit' and existing_membership %}value="{{ existing_membership.planned_pace }}"{% endif %} {% if is_form_disabled %}disabled{% endif %}>
                            <div class="form-text">Format: MM:SS (e.g., 7:30 for 7 minutes 30 seconds per mile). Your captain will adjust times to account for the elevation and street conditions of each leg.</div>
                        </div>

                        <div class="mb-3">
                            <label for="preferred_station" class="form-label">
                                <ion-icon name="train" class="me-1"></ion-icon>
                                Which station is closest to where you'd like to finish?
                            </label>
                            <select class="form-select" id="preferred_station" name="preferred_station" {% if is_form_disabled %}disabled{% endif %}>
                                <option value="">No Preference</option>
                                {% for station in stations %}
                                <option value="{{ station }}" {% if mode == 'edit' and existing_membership and existing_membership.preferred_station == station %}selected{% endif %}>{{ station }}</option>
                                {% endfor %}
                            </select>
                            <div class="form-text">Choose the station closest to where you'd like to stop running.</div>
                        </div>

                        <div class="mb-4">
                            <label for="comments" class="form-label">
                                <ion-icon name="chatbubble-ellipses" class="me-1"></ion-icon>
                                Any notes or comments for scheduling?
                            </label>
                            <textarea class="form-control" id="comments" name="comments" rows="3"
                                      placeholder="Please let us know if you have hard constraints that would prevent your participation..." {% if is_form_disabled %}disabled{% endif %}>{% if mode == 'edit' and existing_membership %}{{ existing_membership.comments or '' }}{% endif %}</textarea>
                            <div class="form-text">Share any scheduling constraints, preferences, or other relevant information</div>
                        </div>

                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="email_opt_in" name="email_opt_in" value="true" {% if mode == 'edit' and current_user.email_opt_in %}checked{% endif %} {% if is_form_disabled %}disabled{% endif %}>
                                <label class="form-check-label" for="email_opt_in">
                                    <ion-icon name="mail-outline" class="me-1"></ion-icon>
                                    Opt-in for information about the next event.
                                </label>
                                <div class="form-text">We'll only email you about the next official running event.</div>
                            </div>
                        </div>

                        {% if mode != 'edit' %}
                        <div class="mb-4">
                            <h5 class="mb-3">
                                <ion-icon name="document-text" class="me-2"></ion-icon>
                                Waiver Agreement
                            </h5>
                            <div class="card bg-secondary">
                                <div class="card-body">
                                    <p class="card-text text-muted">
                                        <em>Waiver text will be provided here...</em>
                                    </p>
                                </div>
                            </div>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="waiver_agreed" name="waiver_agreed" required>
                                <label class="form-check-label" for="waiver_agreed">
                                    <span class="text-danger">*</span> I have read and understood the terms and conditions of the waiver, and I agree to abide by them
                                </label>
                            </div>
                        </div>
                        {% else %}
                        <input type="hidden" name="waiver_agreed" value="on">
                        {% endif %}

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            {% if mode == 'edit' and existing_membership and not is_form_disabled %}
                                {% if existing_team and existing_team.status == 'withdrawn' %}
                                    {% if current_user.is_captain_of(existing_team) %}
                                    <button type="button" class="btn btn-outline-success" onclick="unwithdrawTeam('{{ existing_team.name }}', '{{ existing_team.id }}')">
                                        <ion-icon name="checkmark-circle-outline" class="me-1"></ion-icon>
                                        Un-withdraw Team
                                    </button>
                                    {% else %}
                                    <!-- No buttons for withdrawn teams - non-captains need to join a different team -->
                                    {% endif %}
                                {% elif existing_membership.status == 'withdrawn' %}
                                <button type="button" class="btn btn-success" id="unwithdraw-btn" onclick="unwithdrawMembership('{{ existing_membership.id }}')">
                                    <ion-icon name="checkmark-circle" class="me-1"></ion-icon>
                                    Re-join Team
                                </button>
                                {% elif existing_membership.status == 'removed' %}
                                <!-- No buttons for removed users - they need to join a different team -->
                                {% else %}
                                <button type="button" class="btn btn-outline-warning me-md-2" onclick="withdrawMembership('{{ existing_membership.id }}')">
                                    <ion-icon name="exit-outline" class="me-1"></ion-icon>
                                    Withdraw from Team
                                </button>
                                <button type="submit" class="btn btn-primary" id="submit-btn">
                                    <ion-icon name="create" class="me-1"></ion-icon>
                                    Update Preferences
                                </button>
                                {% endif %}
                            {% elif mode != 'edit' %}
                            <button type="submit" class="btn btn-primary" id="submit-btn">
                                <ion-icon name="person-add" class="me-1"></ion-icon>
                                Join Team
                            </button>
                            {% endif %}
                        </div>
                    </form>

                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { membershipAPI, teamAPI, api, Utils } from '{{ url_for("static", filename="js/api-client.js") }}';

// Handle team selection changes to show/hide password field
const teamSelect = document.getElementById('team_id');
const passwordSection = document.getElementById('password-section');
const passwordInput = document.getElementById('team_password');

if (teamSelect && passwordSection) {
    function updatePasswordField() {
        const selectedOption = teamSelect.options[teamSelect.selectedIndex];
        const passwordRequired = selectedOption.getAttribute('data-password-required') === 'true';

        if (passwordRequired && teamSelect.value) {
            passwordSection.style.display = 'block';
            passwordInput.required = true;
        } else {
            passwordSection.style.display = 'none';
            passwordInput.required = false;
            passwordInput.value = '';
        }
    }

    teamSelect.addEventListener('change', updatePasswordField);

    // Check on page load in case team is pre-selected
    updatePasswordField();
}

// Format pace input as user types using shared utility
const plannedPaceInput = document.getElementById('planned_pace');
if (plannedPaceInput) {
    Utils.formatTimeInput(plannedPaceInput, 99);
}

document.getElementById('join-team-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const submitBtn = document.getElementById('submit-btn');
    const alertContainer = document.getElementById('alert-container');

    // Clear previous alerts
    api.clearAlerts(alertContainer);

    // Determine which endpoint to use
    const currentPath = window.location.pathname;
    const isEditing = currentPath === '{{ url_for('my_registration') }}';

    let result;
    if (isEditing) {
        result = await membershipAPI.updateMembership(new FormData(this));
    } else {
        result = await membershipAPI.joinTeam(new FormData(this));
    }

    if (result.success) {
        // Show success message
        api.showAlert(alertContainer, 'success', result.data.message, 'checkmark-circle');

        // Redirect after a short delay
        api.redirectAfterDelay(result.data.redirect_url || '{{ url_for("index") }}');
    } else {
        // Show error message
        api.showAlert(alertContainer, 'danger', result.error || 'Failed to submit form', 'warning');
    }
});

// Membership management functions using shared API client
window.withdrawMembership = async function(membershipId) {
    if (!confirm('Are you sure you want to withdraw from this team? This action will mark your registration as withdrawn.')) {
        return;
    }

    const result = await membershipAPI.withdrawMembership('{{ existing_team.id if existing_team else "" }}', membershipId);

    if (result.success) {
        // Show success alert
        api.showAlert('alert-container', 'success', result.data.message, 'checkmark-circle');
        // Redirect after a short delay
        api.redirectAfterDelay('{{ url_for("index") }}');
    } else {
        // Show error alert
        api.showAlert('alert-container', 'danger', result.error || 'Failed to withdraw membership', 'warning');
    }
};

window.unwithdrawMembership = async function(membershipId) {
    if (!confirm('Are you sure you want to re-join this team? This will reactivate your membership.')) {
        return;
    }

    const unwithdrawBtn = document.getElementById('unwithdraw-btn');
    const alertContainer = document.getElementById('alert-container');

    // Show loading state using shared API client
    api.setButtonLoading(unwithdrawBtn, 'Re-joining...');

    const result = await membershipAPI.unwithdrawMembership('{{ existing_team.id if existing_team else "" }}', membershipId);

    if (result.success) {
        // Show success alert
        api.showAlert(alertContainer, 'success', result.data.message, 'checkmark-circle');
        // Redirect after a short delay to refresh the page
        api.redirectAfterDelay(window.location.href);
    } else {
        // Show error alert
        api.showAlert(alertContainer, 'danger', result.error || 'Failed to re-join team', 'warning');
        // Reset button
        api.resetButton(unwithdrawBtn);
    }
};

window.unwithdrawTeam = async function(teamName, shortId) {
    if (!confirm(`Are you sure you want to un-withdraw team "${teamName}" and re-enter the event?`)) {
        return;
    }

    const result = await teamAPI.unwithdrawTeam(shortId);

    if (result.success) {
        // Show success alert
        api.showAlert('alert-container', 'success', result.data.message, 'checkmark-circle');
        // Redirect after a short delay
        api.redirectAfterDelay(window.location.href);
    } else {
        // Show error alert
        api.showAlert('alert-container', 'danger', result.error || 'Failed to un-withdraw team', 'warning');
    }
};
</script>
{% include '_footer.html' %}

</body>
</html>